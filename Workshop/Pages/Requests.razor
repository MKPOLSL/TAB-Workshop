@page "/requests"
@page "/requests/{WorkerId:guid}"
@inject Microsoft.AspNetCore.Components.NavigationManager navigationManager
@inject IRequestService requestService
@inject IEmployeeService employeeService
@attribute [AuthorizeRoles(Role.Manager)]
<h1>Zgłoszenia</h1>

@if (requests == null)
{
<div class="spinner"></div> 
}            
else if (requests.Any())
{
<table id="activityTable" class="table table-striped table-bordered" style="text-align:center;">
    <thead>
        <tr>
            <th>Klient</th>
            <th>Marka pojazdu</th>
            <th>Model</th>
            <th>Opis</th>
            <th>Wynik</th>
            <th>Data rejestracji zgłoszenia</th>
            <th>Data zakończenia zgłoszenia</th>
            <th>Status</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var request in requests)
        {
        <tr>
            <td>@request.Car.Client.FirstName @request.Car.Client.LastName</td>
            <td>@request.Car.Brand</td>
            <td>@request.Car.Model</td>
            <td>@request.Description</td>
            <td>@request.Result</td>
            <td>@request.Reqistered</td>
            <td>@request.FinishedOrCancelled</td>
            <td><span class="badge badge-@Badges.GetBadge(request.Status)">@request.Status.GetDisplayName()</span></td>
            @if (WorkerId == Guid.Empty)
            {
                @if (request.Activities.Any())
                {
                    <td><button type="button" class="btn btn-warning" @onclick="() => DecomposeActivity(request)">Edytuj czynności</button></td>
                }
                else
                {
                    <td><button type="button" class="btn btn-primary" @onclick="() => DecomposeActivity(request)">Przypisz czynności</button></td>
                }
            }
            else
            {
                <td><button type="button" class="btn btn-primary" @onclick="() => ShowRequests(request)">Przypisz czynności</button></td>
            }
        </tr>
        } 
    </tbody>
</table> 
}
else {
<div style="padding-top: 25px">
    <h2>Nie masz żadnych zgłoszeń</h2>
</div>
}

@code { 
    [Parameter]
    public Guid WorkerId { get; set; }
    public IEnumerable<Request> requests;
    private Employee manager;

    protected override async Task OnInitializedAsync()
    {
        requests = await requestService.GetAllRequests();
        manager = await employeeService.GetUserFromLocalStorage();
        requests = requests.Where(r => r.Manager == manager);
        await base.OnInitializedAsync();
    }

    protected void DecomposeActivity(Request request)
    {
        navigationManager.NavigateTo($"/addActivities/{request.Id}");
    }

    protected void ShowRequests(Request request)
    {
        navigationManager.NavigateTo($"/assignActivities/{WorkerId}/{request.Id}");
    }
}
